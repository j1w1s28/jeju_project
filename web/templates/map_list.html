{% extends 'base.html' %}
{% block mapList %}
<div style="padding: 0; margin: 0 auto 300px;">
    <span style="font-size: 18pt; font-weight: bold; display: block; margin-bottom: 10px">ìŠ¤ë§ˆíŠ¸ íŒŒì¸ë”</span>
    <!-- ì¥ì†Œëª… í…Œì´ë¸” -->
    <div class="scrollBar" style="overflow-x: hidden; overflow-y: scroll; height: 630px; width: 390px; background-color: #fff; border-radius: 10px; position: absolute">
        <div class="about_text">
            <table class="table table-hover">
                <tbody id="jeju_list" style="border-radius: 10px"></tbody>
            </table>
            <script>
                // ì˜¤ë¥¸ìª½ ì„ íƒëœ ì¥ì†Œ ì¶”ê°€ í•¨ìˆ˜
                function addSelected(add_list){
                    for (var key in add_list) {
                            var selected =  '<div class="col-2" style="margin-top:10px;margin-bottom:5px"><img src="{{ url_for("static", filename="img/circle2.png")}}" height=25 width="25"></div>'+
                                            '<div class="col" style="width: 180; margin-top:10px;margin-bottom:5px;word-break:keep-all;"><b>'+key+'</b></div>'+
                                            '<div class="w-100"></div>'+
                                            '<div class="col-2" style="margin-top:5px;margin-bottom:5px"><img src="{{ url_for("static", filename="img/minus2.png")}}" height=100% width="25"></div>'+
                                            '<div class="col" style="font-size:13px; margin-top:5px; margin-bottom:5px; width: 180px; table-layout:fixed;">'+add_list[key]+'<br></div>'+
                                            '<div class="w-100"></div>'

                            document.querySelector('#selected_title').innerHTML += selected
                        }
                }

                // ë¦¬ìŠ¤íŠ¸ì—ì„œ í•˜íŠ¸ í´ë¦­ì‹œ í•¨ìˆ˜
                var add_list = [];
                var linePath = [];
                var idChecker = [];
                var tmpPoly;

                function addBtn(click_id) {
                    var title = document.querySelector("#"+click_id).value.trim()
                    var tag = positions[click_id.split('_')[1]].tag.split(',').slice(0,5)
                    document.querySelector('#selected_title').innerHTML = ''
                    // ì„  ì§€ìš°ê¸°
                    if(tmpPoly != undefined) {
                        tmpPoly.setMap(null);
                    }

                    // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                    if(document.querySelector("#"+click_id).checked) {
                        document.querySelector("#"+click_id).checked = true;
                        if(document.querySelector("#Info"+click_id)!=null){
                            document.querySelector("#Info"+click_id).checked = true;
                        }
                        add_list[title] = tag;

                        // ì¶”ê°€ì‹œ ìœ„ë„ ê²½ë„
                        x = positions[click_id.split('_')[1]].latlng.Ma;
                        y = positions[click_id.split('_')[1]].latlng.La;
                        linePath.push(new kakao.maps.LatLng(x, y));
                        idChecker.push(click_id);
                    }
                    else {
                        document.querySelector("#"+click_id).checked = false;
                        if(document.querySelector("#Info"+click_id)!=null){
                            document.querySelector("#Info"+click_id).checked = false;
                        }
                        delete add_list[title];
                        let index = idChecker.indexOf(click_id);
                        // ì¶”ê°€ ì·¨ì†Œ ì‹œ ë°°ì—´ì—ì„œ ë¹¼ê¸°
                        linePath.splice(index, 1);
                        idChecker.splice(index, 1);
                    }

                    //ì„  í‘œì‹œ
                    var polyline = new kakao.maps.Polyline({
                                    path: linePath, // ì„ ì„ êµ¬ì„±í•˜ëŠ” ì¢Œí‘œë°°ì—´ ì…ë‹ˆë‹¤
                                    strokeWeight: 2, // ì„ ì˜ ë‘ê»˜ ì…ë‹ˆë‹¤
                                    strokeColor: '#1478FF', // ì„ ì˜ ìƒ‰ê¹”ì…ë‹ˆë‹¤
                                    strokeOpacity: 0.7, // ì„ ì˜ ë¶ˆíˆ¬ëª…ë„ ì…ë‹ˆë‹¤ 1ì—ì„œ 0 ì‚¬ì´ì˜ ê°’ì´ë©° 0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ íˆ¬ëª…í•©ë‹ˆë‹¤
                                    strokeStyle: 'solid' // ì„ ì˜ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤
                                });
                    tmpPoly = polyline;
                    polyline.setMap(map);

                    addSelected(add_list);


                }

                // ì¸í¬ì°½ì—ì„œ í•˜íŠ¸ í´ë¦­ì‹œ í•¨ìˆ˜
                function addInfoBtn(Info_click_id){
                    click_id = Info_click_id.replace("Info","")
                    if(document.querySelector("#"+Info_click_id).checked) {
                        document.querySelector("#"+click_id).checked=true;
                    }
                    else {
                        document.querySelector("#"+click_id).checked=false;
                    }
                    addBtn(click_id);
                }
            </script>
        </div>
    </div>

    <!-- ì§€ë„ -->
    <div>
        <div id="map" style="width: 690px; height: 630px; border-radius: 10px; position: absolute; margin-left: 400px">
            <!-- ì§€ë„ ìœ„ì— í‘œì‹œë  ë§ˆì»¤ ì¹´í…Œê³ ë¦¬ -->
            <div class="category btn-group opacity-85" role="group" aria-label="Basic checkbox toggle button group">
                <input type="checkbox" class="btn-check" id="category1" autocomplete="off" value="ìŒì‹ì " onclick="clickCategory()" />
                <label class="btn btn-outline-danger" for="category1">ğŸ”<br />ìŒì‹ì </label>

                <input type="checkbox" class="btn-check" id="category2" autocomplete="off" value="ê´€ê´‘ì§€" onclick="clickCategory()" checked />
                <label class="btn btn-outline-warning" for="category2">ğŸ¡<br />ê´€ê´‘ì§€</label>

                <input type="checkbox" class="btn-check" id="category3" autocomplete="off" value="ìˆ™ë°•" onclick="clickCategory()" checked />
                <label class="btn btn-outline-primary" for="category3">ğŸ <br />ìˆ™ë°•</label>
            </div>
        </div>

        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e60591e1e917a164c421ab8844f09e08"></script>
        <script>
            var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div
                mapOption = {
                    center: new kakao.maps.LatLng(33.375, 126.55), // í•œë¼ì‚° ì¢Œí‘œ
                    level: 10, // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
                };

            var map = new kakao.maps.Map(mapContainer, mapOption); // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
            // map.setMaxLevel(10);
            // map.setBounds((33.27468472204246, 125.97603087677453), (34.04423387381139, 127.39200174133641)); // ì§€ë„ ì´ë™ ë²”ìœ„ ì œí•œ

            // ì¼ë°˜ ì§€ë„ì™€ ìŠ¤ì¹´ì´ë·°ë¡œ ì§€ë„ íƒ€ì…ì„ ì „í™˜í•  ìˆ˜ ìˆëŠ” ì§€ë„íƒ€ì… ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•©ë‹ˆë‹¤
            // var mapTypeControl = new kakao.maps.MapTypeControl();
            // map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

            // ì§€ë„ í™•ëŒ€ ì¶•ì†Œë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ”  ì¤Œ ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•©ë‹ˆë‹¤
            // var zoomControl = new kakao.maps.ZoomControl();
            // map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

            // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ìœ„ì¹˜ì™€ title ê°ì²´ ë°°ì—´
            var food = [];
            var stay = [];
            var place = [];
            ('{% for i in range(result[1]) %}');
            x = Number('{{result[0][i]["latitude"]}}');
            y = Number('{{result[0][i]["longitude"]}}');
            tmp = {
                id: '{{i}}',
                title: '{{result[0][i]["title"]}}',
                tag: '{{result[0][i]["alltag"]}}',
                address: '{{result[0][i]["address"]}}',
                roadaddress: '{{result[0][i]["roadaddress"]}}',
                phoneno: '{{result[0][i]["phoneno"]}}',
                content: '{{result[0][i]["contentscd"]}}',
                img_thumb: '{{result[0][i]["thumbnailpath"]}}',
                latlng: new kakao.maps.LatLng(x, y),
            };
            ('{% if(result[0][i]["contentscd"] == "ìŒì‹ì ") %}');
            food.push(tmp);
            ('{% elif(result[0][i]["contentscd"] == "ìˆ™ë°•") %}');
            stay.push(tmp);
            ('{% else  %}');
            place.push(tmp);
            ('{% endif %}');
            ('{% endfor %}');

            // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ í•¨ìˆ˜ =======================================================================================
            var positions = [];
            var checker = [];
            function clickCategory() {
                positions = [];
                delLocation(checker);
                if (document.querySelector('#category1').checked) {
                    positions = positions.concat(food);
                }
                if (document.querySelector('#category2').checked) {
                    positions = positions.concat(place);
                }
                if (document.querySelector('#category3').checked) {
                    positions = positions.concat(stay);
                }
                createMarker();

                // ì™¼ìª½ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                document.querySelector('#jeju_list').innerHTML = '';
                for (var i = 0; i < positions.length; i++) {
                    var jejuList =
                        '<tr>' +
                        '<td><a onclick="openwindow(markers[' +
                        i +
                        '], infowindows[' +
                        i +
                        '], ' +
                        i +
                        ')"><img src="' +
                        positions[i]['img_thumb'] +
                        '" height="63" width="65" style="border-radius: 50px;"></a></td>' +
                        '<td style="vertical-align:middle; word-break:break-all; width: 226px; table-layout:fixed; "><a onclick="openwindow(markers[' +
                        i +
                        '], infowindows[' +
                        i +
                        '], ' +
                        i +
                        ')">' +
                        positions[i]['title'] +
                        '</a></td>' +
                        '<td style="vertical-align:middle; padding-right: 0px;">' +
                        '<label class="heart-switch">' +
                        '<input type="checkbox" id="btnId_' +
                        i +
                        '" onClick="addBtn(this.id)" value="' +
                        positions[i]['title'] +
                        '"' +
                        (positions[i]['title'] in add_list ? 'checked' : '') +
                        '>' +
                        '<svg viewBox="0 0 33 23" fill="white">' +
                        '<path d="M23.5,0.5 C28.4705627,0.5 32.5,4.52943725 32.5,9.5 C32.5,16.9484448 21.46672,22.5 16.5,22.5 C11.53328,22.5 0.5,16.9484448 0.5,9.5 C0.5,4.52952206 4.52943725,0.5 9.5,0.5 C12.3277083,0.5 14.8508336,1.80407476 16.5007741,3.84362242 C18.1491664,1.80407476 20.6722917,0.5 23.5,0.5 Z"></path>' +
                        '</svg>' +
                        '</label>' +
                        '</td>' +
                        '</tr>';
                    // console.log(positions[i])
                    document.querySelector('#jeju_list').innerHTML += jejuList;
                }
            }
            // =======================================================================================

            // ë§ˆì»¤ ì‚­ì œ í•¨ìˆ˜
            function delLocation(Loc) {
                for (let i = 0; i < Loc.length; i++) {
                    Loc[i].setMap(null);
                }
            }

            // ë§ˆì»¤ ì´ë¯¸ì§€ì˜ ì´ë¯¸ì§€ ì£¼ì†Œ
            var imageSrc_s = 'https://cdn-icons-png.flaticon.com/512/727/727590.png'; //ìˆ™ì†Œ
            var imageSrc_f = 'https://cdn-icons-png.flaticon.com/512/4108/4108022.png'; //ìŒì‹
            var imageSrc_p = 'https://cdn-icons-png.flaticon.com/512/727/727606.png'; //ê´€ê´‘ì§€

            // ë§ˆì»¤ ì´ë¯¸ì§€ì˜ ì´ë¯¸ì§€ í¬ê¸°
            var imageSize = new kakao.maps.Size(24, 25);
            var infowindows = [];
            var markers = [];

            function createMarker() {
                infowindows = [];
                markers = [];

                // ë§ˆì»¤ ìƒì„±
                for (var i = 0; i < positions.length; i++) {
                    // ë§ˆì»¤ ì´ë¯¸ì§€ë¥¼ ìƒì„±
                    if (positions[i].content === 'ìˆ™ë°•') {
                        var markerImage = new kakao.maps.MarkerImage(imageSrc_s, imageSize);
                    } else if (positions[i].content === 'ìŒì‹ì ') {
                        var markerImage = new kakao.maps.MarkerImage(imageSrc_f, imageSize);
                    } else {
                        var markerImage = new kakao.maps.MarkerImage(imageSrc_p, imageSize);
                    }

                    var marker = new kakao.maps.Marker({
                        map: map, // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ì§€ë„
                        position: positions[i].latlng, // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ìœ„ì¹˜
                        image: markerImage, // ë§ˆì»¤ ì´ë¯¸ì§€
                        clickable: true,
                    });
                    markers.push(marker);
                    checker.push(marker);

                    var contents =
                        '<div class="wrap">' +
                        '<div class="info"">' +
                        '<div class="title" id="info_' +
                        i +
                        '"><div style="position: absolute; height: 17px; "><img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/overlay_close.png" style="padding-bottom: 3px; margin-left:280px" onclick="infoClose();"></div>' +
                        positions[i].title +
                        '</div>' +
                        '<div class="body">' +
                        // '<div class="img">' + '<img src='+ positions[i].img + 'width="73" height="70">'+'</div>' +
                        '<div class="desc">' +
                        '<div class="address">' +
                        positions[i].roadaddress.replace(/"/g, '') +
                        '</div>' +
                        '<div class="phoneno">' +
                        positions[i].phoneno.replace(/"/g, '') +
                        '</div>' +
                        '<div class="phoneno">' +
                        '<label class="heart-switch">' +
                        '<input type="checkbox" id="InfobtnId_' +
                        i +
                        '" onClick="addInfoBtn(this.id)"' +
                        (positions[i]['title'] in add_list ? 'checked' : '') +
                        '>' +
                        '<svg viewBox="0 0 33 23" fill="white">' +
                        '<path d="M23.5,0.5 C28.4705627,0.5 32.5,4.52943725 32.5,9.5 C32.5,16.9484448 21.46672,22.5 16.5,22.5 C11.53328,22.5 0.5,16.9484448 0.5,9.5 C0.5,4.52952206 4.52943725,0.5 9.5,0.5 C12.3277083,0.5 14.8508336,1.80407476 16.5007741,3.84362242 C18.1491664,1.80407476 20.6722917,0.5 23.5,0.5 Z"></path>' +
                        '</svg>' +
                        '</label>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>';

                    // ì¸í¬ìœˆë„ìš°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                    var infowindow = new kakao.maps.InfoWindow({
                        content: contents,
                    });
                    infowindows.push(infowindow);

                    // ë§ˆì»¤ í´ë¦­í•˜ë©´ ì¸í¬ìœˆë„ìš°
                    kakao.maps.event.addListener(marker, 'click', makeClickListener(map, marker, infowindow, i));
                }
            }

            function infoClose() {
                infowindows[windowChecker].close(map, markers[windowChecker]);
                circle.setMap(null);
            }

            document.getElementById('category1').click();
            // document.getElementById('category2').click();
            // document.getElementById('category3').click();

            function infoColor(i, map, marker) {
                // ì¹´í…Œê³ ë¦¬ì— ë”°ë¥¸ íŒì—… ìƒ‰ ë³€ê²½
                if (positions[i].content == 'ìˆ™ë°•') {
                    document.querySelector('#info_' + i).style.background = '#57A8EB';
                } else if (positions[i].content == 'ìŒì‹ì ') {
                    document.querySelector('#info_' + i).style.background = '#fc868a';
                } else {
                    document.querySelector('#info_' + i).style.background = '#facf4c';
                }
            }

            // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ //
            windowChecker = undefined;
            var circle = new kakao.maps.Circle({});
            function makeClickListener(map, marker, infowindow, i) {
                return function () {
                    var moveLatLon = positions[i].latlng;
                    moveAndCircle(moveLatLon);

                    // ì •ë³´ íŒì—…
                    if (windowChecker != undefined) {
                        infowindows[windowChecker].close(map, markers[windowChecker]);
                    }
                    infowindow.open(map, marker);
                    infoColor(i, map, marker);
                    windowChecker = i;
                };
            }

            function openwindow(marker, infowindow, i) {
                // ì´ë™í•  ìœ„ë„ ê²½ë„ ìœ„ì¹˜ ìƒì„±
                var moveLatLon = positions[i].latlng;
                moveAndCircle(moveLatLon);

                if (windowChecker != undefined) {
                    infowindows[windowChecker].close(map, markers[windowChecker]);
                }
                infowindow.open(map, marker);
                infoColor(i);
                windowChecker = i;
            }

            function moveAndCircle(moveLatLon) {
                // ì§€ë„ ì´ë™
                map.setCenter(moveLatLon);
                // map.panTo(moveLatLon);

                // ì§€ë„ í™•ëŒ€
                map.setLevel(7);
                // ì§€ë„ì— í‘œì‹œí•  ì›ì„ ìƒì„±, í‘œì‹œ
                circle.setMap(null); // ê¸°ì¡´ ì› ì´ˆê¸°í™”
                circle = new kakao.maps.Circle({
                    center: moveLatLon, // ì›ì˜ ì¤‘ì‹¬ì¢Œí‘œ ì…ë‹ˆë‹¤
                    radius: 5000, // ë¯¸í„° ë‹¨ìœ„ì˜ ì›ì˜ ë°˜ì§€ë¦„ì…ë‹ˆë‹¤
                    strokeWeight: 1, // ì„ ì˜ ë‘ê»˜ì…ë‹ˆë‹¤
                    strokeColor: '#75B8FA', // ì„ ì˜ ìƒ‰ê¹”ì…ë‹ˆë‹¤
                    strokeOpacity: 0.5, // ì„ ì˜ ë¶ˆíˆ¬ëª…ë„ ì…ë‹ˆë‹¤ 1ì—ì„œ 0 ì‚¬ì´ì˜ ê°’ì´ë©° 0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ íˆ¬ëª…í•©ë‹ˆë‹¤
                    fillColor: '#CFE7FF', // ì±„ìš°ê¸° ìƒ‰ê¹”ì…ë‹ˆë‹¤
                    fillOpacity: 0.5, // ì±„ìš°ê¸° ë¶ˆíˆ¬ëª…ë„ ì…ë‹ˆë‹¤
                });
                circle.setMap(map);
            }
        </script>
    </div>

    <!-- ì„ íƒ ì¥ì†Œ div -->
    <div style="width: 300px; height: 630px; margin-left: 1100px">
        <div class="scrollBar" style="width: 100%; overflow-x: hidden; overflow-y: scroll; height: 580px; padding: 5px; background-color: #fff; border-radius: 10px">
            <div class="row" id="selected_title"></div>
        </div>
        <div class="d-grid gap-2" style="margin-top: 10px; padding-right: 10px">
            <button class="btn btn-primary" type="button" onclick="reset()">ì´ˆê¸°í™”</button>
            <script>
                function reset() {
                    if (window.confirm('ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        window.location.reload(); // ìƒˆë¡œê³ ì¹¨
                    }
                }
            </script>
        </div>
    </div>
</div>

<!-- Graphê³µê°„ -->
{% block graph %}
{% endblock %}

{% endblock %}