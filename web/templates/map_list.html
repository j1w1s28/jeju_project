<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"> -->
    <!-- <link rel="stylesheet" href="./css/bootstrap.min.css"> -->
    <style>
        /* ì§€ë„ ì¸í¬ íŒì—… */
        .wrap .info {width:320px; height: 110px;}
        .info .body {position: relative; overflow: hidden;}
        .info .title {font-family: 'Malgun Gothic', dotum, 'ë‹ì›€'; text-align:center; padding: 10px; font-weight:bold;}
        .desc .address {font-family: 'Malgun Gothic', dotum, 'ë‹ì›€'; margin:10px 5px 5px 5px; text-align:center; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .desc .phoneno {font-family: 'Malgun Gothic', dotum, 'ë‹ì›€'; margin:5px 5px 5px 5px; text-align:center; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .info .close:hover {cursor: pointer;}

        /* ì§€ë„ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ */
        .category {position:absolute;top:10px;left:10px;width:230px;height:60px;z-index:10; font-family:'Malgun Gothic','ë§‘ì€ ê³ ë”•',sans-serif;font-size:12px;text-align:center;background-color:#fff;border-radius: 4px;}

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .scrollBar { 
        /* width: 400px; */
        /* height: 200px; */
        overflow-y: scroll;
        }

        .scrollBar::-webkit-scrollbar {
            width: 10px;  /* ìŠ¤í¬ë¡¤ë°”ì˜ ë„ˆë¹„ */
        }
        
        .scrollBar::-webkit-scrollbar-thumb {
            height: 30%; /* ìŠ¤í¬ë¡¤ë°”ì˜ ê¸¸ì´ */
            background: #217af4; /* ìŠ¤í¬ë¡¤ë°”ì˜ ìƒ‰ìƒ */
            
            border-radius: 10px;
        }

        .scrollBar::-webkit-scrollbar-track {
            background: rgba(33, 122, 244, .1);  /*ìŠ¤í¬ë¡¤ë°” ë’· ë°°ê²½ ìƒ‰ìƒ*/
        }
    </style>
    <title>ì œì£¼ë„ ì§€ë„ ğŸ—º</title>
    
</head>
<body>
    <div class="container-fluid" style="padding: 0;">
        <div class="row">
            <!-- ì¥ì†Œëª… í…Œì´ë¸” -->
            <div class="scrollBar" style="overflow-x:hidden; overflow-y:scroll; height:700px; width:400px;">
                <div class="about_text" >
                    <table class="table table-hover">
                        <tbody id="jeju_list">
                        </tbody> 
                    </table>
                    <script>
                        // ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ í•¨ìˆ˜
                        var add_list = []
                        var linePath = [];
                        var idChecker = [];
                        var tmpPoly;

                        function add_btn(click_id) {
                            var title = document.querySelector("#"+click_id).value.trim()
                            var tag = positions[click_id.split('_')[1]].tag.split(',').slice(0,5)
                            document.querySelector('#selected_title').innerHTML = ''
                            
                            // ì„  ì§€ìš°ê¸°
                            if(tmpPoly != undefined) {
                                tmpPoly.setMap(null);
                            }

                            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                            if(document.querySelector("#"+click_id).innerHTML == 'ì¶”ê°€') {
                                document.querySelector("#"+click_id).innerHTML = "ì„ íƒ";
                                document.querySelector("#"+click_id).className = 'btn btn-primary btn-sm'
                                add_list[title] = tag;

                                // ì¶”ê°€ì‹œ ìœ„ë„ ê²½ë„ 
                                x = positions[click_id.split('_')[1]].latlng.Ma;
                                y = positions[click_id.split('_')[1]].latlng.La;
                                linePath.push(new kakao.maps.LatLng(x, y));
                                idChecker.push(click_id);
                            }
                            else{
                                document.querySelector("#"+click_id).innerHTML = "ì¶”ê°€";
                                document.querySelector("#"+click_id).className = 'btn btn-outline-primary btn-sm'
                                delete add_list[title];
                                let index = idChecker.indexOf(click_id);
                                // ì¶”ê°€ ì·¨ì†Œ ì‹œ ë°°ì—´ì—ì„œ ë¹¼ê¸°
                                linePath.splice(index, 1);
                                idChecker.splice(index, 1);
                            }
                            //ì„  í‘œì‹œ 
                            var polyline = new kakao.maps.Polyline({
                                            path: linePath, // ì„ ì„ êµ¬ì„±í•˜ëŠ” ì¢Œí‘œë°°ì—´ ì…ë‹ˆë‹¤
                                            strokeWeight: 2, // ì„ ì˜ ë‘ê»˜ ì…ë‹ˆë‹¤
                                            strokeColor: '#1478FF', // ì„ ì˜ ìƒ‰ê¹”ì…ë‹ˆë‹¤
                                            strokeOpacity: 0.7, // ì„ ì˜ ë¶ˆíˆ¬ëª…ë„ ì…ë‹ˆë‹¤ 1ì—ì„œ 0 ì‚¬ì´ì˜ ê°’ì´ë©° 0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ íˆ¬ëª…í•©ë‹ˆë‹¤
                                            strokeStyle: 'solid' // ì„ ì˜ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤
                                        });
                            tmpPoly = polyline;
                            polyline.setMap(map);

                            // ì„ íƒëœ ì¥ì†Œ ì¶”ê°€
                            for (var key in add_list) {
                                var selected =  '<div class="col-2" style="margin-top:10px;margin-bottom:5px"><img src="{{ url_for('static', filename='img/circle2.png')}}" height=25 width="25"></div>'+
                                                '<div class="col" style="margin-top:10px;margin-bottom:5px;word-break:keep-all;"><b>'+key+'</b></div>'+
                                                '<div class="w-100"></div>'+
                                                '<div class="col-2" style="margin-top:5px;margin-bottom:5px"><img src="{{ url_for('static', filename='img/minus2.png')}}" height=100% width="25"></div>'+
                                                '<div class="col" style="margin-top:5px;margin-bottom:5px;word-break:keep-all;">'+add_list[key]+'<br></div>'+
                                                '<div class="w-100"></div>'

                                document.querySelector('#selected_title').innerHTML += selected
                            }
                        }
                    </script>
                </div>
            </div>

            <!-- ì§€ë„ -->
            <div class="col-sm-7" style="padding: 0px;">
                <div id="map" style="width:100%;height:700px;">
                    <!-- ì§€ë„ ìœ„ì— í‘œì‹œë  ë§ˆì»¤ ì¹´í…Œê³ ë¦¬ -->
                    <div class="category btn-group" role="group" aria-label="Basic checkbox toggle button group">
                        <input type="checkbox" class="btn-check" id="category1" autocomplete="off" value='ìŒì‹ì ' onclick="clickCategory()">
                        <label class="btn btn-outline-danger" for="category1">ğŸ”<br>ìŒì‹ì </label>
                        
                        <input type="checkbox" class="btn-check" id="category2" autocomplete="off" value='ê´€ê´‘ì§€' onclick="clickCategory()">
                        <label class="btn btn-outline-warning" for="category2">ğŸ¡<br>ê´€ê´‘ì§€</label>
                        
                        <input type="checkbox" class="btn-check" id="category3" autocomplete="off" value='ìˆ™ë°•' onclick="clickCategory()">
                        <label class="btn btn-outline-primary" for="category3">ğŸ <br>ìˆ™ë°•</label>
                    </div>
                </div>

                <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e60591e1e917a164c421ab8844f09e08"></script>
                <script>

                var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div  
                    mapOption = { 
                        center: new kakao.maps.LatLng(33.375, 126.55), // í•œë¼ì‚° ì¢Œí‘œ
                        level: 10 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
                    };

                var map = new kakao.maps.Map(mapContainer, mapOption); // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                
                // ì¼ë°˜ ì§€ë„ì™€ ìŠ¤ì¹´ì´ë·°ë¡œ ì§€ë„ íƒ€ì…ì„ ì „í™˜í•  ìˆ˜ ìˆëŠ” ì§€ë„íƒ€ì… ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•©ë‹ˆë‹¤
                // var mapTypeControl = new kakao.maps.MapTypeControl();
                // map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

                // ì§€ë„ í™•ëŒ€ ì¶•ì†Œë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ”  ì¤Œ ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•©ë‹ˆë‹¤
                var zoomControl = new kakao.maps.ZoomControl();
                map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);


                // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ìœ„ì¹˜ì™€ title ê°ì²´ ë°°ì—´
                var allPositions = [];
                '{% for i in range(result[1]) %}'
                    x = Number('{{result[0][i]["latitude"]}}');
                    y = Number('{{result[0][i]["longitude"]}}');
                    tmp = {
                        title: '{{result[0][i]["title"]}}', 
                        tag: '{{result[0][i]["alltag"]}}',
                        address: '{{result[0][i]["address"]}}',
                        roadaddress:'{{result[0][i]["roadaddress"]}}', 
                        phoneno: '{{result[0][i]["phoneno"]}}', 
                        content : '{{result[0][i]["contentscd"]}}',
                        img_thumb: '{{result[0][i]["thumbnailpath"]}}', 
                        latlng: new kakao.maps.LatLng(x, y)
                    };
                    allPositions.push(tmp);
                '{% endfor %}'

                // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ í•¨ìˆ˜ =======================================================================================
                var positions = [];
                var checker = [];
                function clickCategory() {
                    positions = [];
                    delLocation(checker);
                    if(document.querySelector('#category1').checked){
                        positions = positions.concat(
                            allPositions.filter(function(obj) {
                                return (obj.content === "ìŒì‹ì ");
                            })
                        );
                    }
                    if(document.querySelector('#category2').checked){
                        positions = positions.concat(
                            allPositions.filter(function(obj) {
                                return (obj.content === "ê´€ê´‘ì§€" || obj.content === "ì‡¼í•‘" || obj.content === "ì¶•ì œ/í–‰ì‚¬");
                            })
                        );
                    }
                    if(document.querySelector('#category3').checked){
                        positions = positions.concat(
                            allPositions.filter(function(obj) {
                                return (obj.content === "ìˆ™ë°•");
                            })
                        );
                    }
                    createMarker();

                    // ì™¼ìª½ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                    document.querySelector('#jeju_list').innerHTML = ""
                    for (var i=0; i < positions.length; i++) {
                        var jejuList =  '<tr>' +
                                            '<td><a onclick="openwindow(markers['+ i +'], infowindows['+ i +'], '+ i +')"><img src="' + positions[i]["img_thumb"] + '" height="63" width="65"></a></td>'+
                                            '<td style="width: 200px; vertical-align:middle; word-break:keep-all; table-layout:fixed"><a onclick="openwindow(markers['+ i +'], infowindows['+ i +'], '+ i +')">' + positions[i]["title"] + '</a></td>'+
                                            '<td style="vertical-align:middle; padding-right: 0px;"><button type="button" class="btn btn-outline-primary btn-sm" id="btnId_'+ i +'" onClick="add_btn(this.id)" value="' + positions[i]["title"] + '">ì¶”ê°€</button></td>'
                                        '</tr>'
                        // console.log(positions[i])
                        document.querySelector('#jeju_list').innerHTML += jejuList

                        if(positions[i]["title"] in add_list) {
                            document.querySelector('#btnId_'+ i).innerHTML = "ì„ íƒ";
                            document.querySelector('#btnId_'+ i).className = 'btn btn-primary btn-sm'
                        }
                    }

                }
                // =======================================================================================


                // ë§ˆì»¤ ì‚­ì œ í•¨ìˆ˜
                function delLocation(Loc) {
                    for(let i=0; i<Loc.length; i++) {
                        Loc[i].setMap(null);
                    }
                }

                // ë§ˆì»¤ ì´ë¯¸ì§€ì˜ ì´ë¯¸ì§€ ì£¼ì†Œ
                var imageSrc_s = "https://cdn-icons-png.flaticon.com/512/727/727590.png"; //ìˆ™ì†Œ
                var imageSrc_f =  "https://cdn-icons-png.flaticon.com/512/4108/4108022.png"; //ìŒì‹
                var imageSrc_p = "https://cdn-icons-png.flaticon.com/512/727/727606.png"; //ê´€ê´‘ì§€

                // ë§ˆì»¤ ì´ë¯¸ì§€ì˜ ì´ë¯¸ì§€ í¬ê¸° ì…ë‹ˆë‹¤
                var imageSize = new kakao.maps.Size(24, 25); 
                var infowindows = [];
                var markers = [];
                
                function createMarker() {
                    infowindows = [];
                    markers = [];

                    // ë§ˆì»¤ ìƒì„±
                    for (var i = 0; i < positions.length; i ++) {
                        
                        // ë§ˆì»¤ ì´ë¯¸ì§€ë¥¼ ìƒì„±
                        if(positions[i].content === "ìˆ™ë°•"){
                            var markerImage = new kakao.maps.MarkerImage(imageSrc_s,imageSize);
                        }else if (positions[i].content === "ìŒì‹ì "){
                            var markerImage = new kakao.maps.MarkerImage(imageSrc_f,imageSize);
                        }else{
                            var markerImage = new kakao.maps.MarkerImage(imageSrc_p,imageSize); 
                        }

                        var marker = new kakao.maps.Marker({
                            map: map, // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ì§€ë„
                            position: positions[i].latlng, // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ìœ„ì¹˜
                            image : markerImage, // ë§ˆì»¤ ì´ë¯¸ì§€ 
                            clickable: true
                        });
                        markers.push(marker);
                        checker.push(marker);

                        var contents = '<div class="wrap">' + 
                                            '<div class="info"">' + 
                                                '<div class="title" id="info_'+i+'">' + positions[i].title +
                                                    '<div class="close" onclick="closeOverlay()" title="ë‹«ê¸°"></div>'+'</div>' + 
                                                    '<div class="body">' +   
                                                        // '<div class="img">' + '<img src='+ positions[i].img + 'width="73" height="70">'+'</div>' + 
                                                        '<div class="desc">' +  
                                                            '<div class="address">' + positions[i].roadaddress.replace(/"/g,'') + '</div>' + 
                                                            '<div class="phoneno">'+ positions[i].phoneno.replace(/"/g,'')+'</div>' +
                                                        '</div>'+
                                                    '</div>' +  
                                                '</div>' + 
                                            '</div>' + 
                                        '</div>',
                            iwRemoveable = true;

                        // ì¸í¬ìœˆë„ìš°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                        var infowindow = new kakao.maps.InfoWindow({
                            content : contents,
                            removable : iwRemoveable
                        });
                        infowindows.push(infowindow);

                        // ë§ˆì»¤ í´ë¦­í•˜ë©´ ì¸í¬ìœˆë„ìš°
                        kakao.maps.event.addListener(marker, 'click', makeClickListener(map, marker, infowindow, i));
                    }
                }

                document.getElementById('category1').click();
                document.getElementById('category2').click();
                document.getElementById('category3').click();

                function infoColor(i){
                    // ì¹´í…Œê³ ë¦¬ì— ë”°ë¥¸ íŒì—… ìƒ‰ ë³€ê²½
                    if(positions[i].content == "ìˆ™ë°•" ) {
                            document.querySelector("#info_"+i).style.background = 'rgb(87, 168, 235)'
                        }else if(positions[i].content == "ìŒì‹ì "){
                            document.querySelector("#info_"+i).style.background = '#fc868a'
                        }else{
                            document.querySelector("#info_"+i).style.background = '#facf4c' 
                        }
                }

                // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ //
                windowChecker = undefined;
                function makeClickListener(map, marker, infowindow, i) {
                    return function() {
                        // ì´ë™í•  ìœ„ë„ ê²½ë„ ìœ„ì¹˜ ìƒì„±
                        var moveLatLon = positions[i].latlng;
                        map.setCenter(moveLatLon);
                        // ì§€ë„ ì´ë™
                        // map.panTo(moveLatLon);
                        // ì§€ë„ í™•ëŒ€
                        map.setLevel(6);

                        // ì •ë³´ íŒì—…
                        if(windowChecker != undefined) {
                        infowindows[windowChecker].close(map, markers[windowChecker]);
                        }
                        infowindow.open(map, marker);
                        infoColor(i);
                        windowChecker = i;
                    };
                }

                function openwindow(marker, infowindow, i) {
                    
                    // ì´ë™í•  ìœ„ë„ ê²½ë„ ìœ„ì¹˜ ìƒì„±
                    var moveLatLon = positions[i].latlng;
                        map.setCenter(moveLatLon);
                        // ì§€ë„ ì´ë™
                        // map.panTo(moveLatLon);
                        // ì§€ë„ í™•ëŒ€
                        map.setLevel(6);

                    if(windowChecker != undefined) {
                        infowindows[windowChecker].close(map, markers[windowChecker]);
                    }
                    infowindow.open(map, marker);
                    infoColor(i);
                    windowChecker = i;
                }
                </script>
            </div>

            <!-- ì„ íƒ ì¥ì†Œ div -->
            <div class="col-sm scrollBar" style="overflow-x:hidden; overflow-y:scroll; height:700px; padding: 5px;">
                <div class="about_text" id="selected_div">
                    <div class="row" id="selected_title"> </div>
                </div>
            </div>

        </div>
    </div>
</body>
</html>